context("Prepare the model from different objects")
library(BioFAMtools)


test_that("a BioFAModel can be prepared from a list of matrices", {
	m <- as.matrix(read.csv('matrix.csv'))
	bfam <- create_biofam(list("view1" = m))
	expect_is(prepare_biofam(bfam), "BioFAModel")
})

test_that("a model can be created from a list of sparse matrices", {
	skip_if_not_installed("Matrix")

	# Generate a sparse matrix
	m <- matrix(rnorm(100 * 5), ncol = 5) %*% t(matrix(rnorm(5 * 50), ncol = 5))
	m[sample(1:nrow(m), 100, replace = TRUE), sample(1:ncol(m), 100, replace = TRUE)] <- 0
	library(Matrix)
	m <- Matrix(m, sparse = TRUE)
	bfam <- create_biofam(list("view1" = m))

	# Test if a sparse matrix can be used to prepare the BioFAModel for training
	expect_is(prepare_biofam(bfam), "BioFAModel")
})

test_that("a model can be created from a Seurat object", {
	skip_if_not_installed("Seurat")

	# Create a Seurat object from demo data
	library(Seurat)
	m <- readMM(url('https://github.com/satijalab/seurat/blob/master/tests/testdata/matrix.mtx?raw=true'))
	genes <- read.delim(url('https://github.com/satijalab/seurat/blob/master/tests/testdata/genes.tsv?raw=true'), sep='\t', header=FALSE)[,1]
	cells <- read.delim(url('https://github.com/satijalab/seurat/blob/master/tests/testdata/barcodes.tsv?raw=true'), sep='\t', header=FALSE)[,1]
	colnames(m) <- cells
	rownames(m) <- genes
	srt <- Seurat::CreateSeuratObject(m)

	# Prepare a model before training
	bfam <- create_biofam(srt)

	# Test if a Seurat object can be used to prepare the BioFAModel for training
	expect_is(prepare_biofam(bfam), "BioFAModel")
})

